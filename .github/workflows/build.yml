name: Build Apps

on:
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive # 确保子模块也被拉取

      - name: Setup Java (for Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install Dependencies & Code Gen
        run: |
          # 1. 先配置核心库
          cd simple_live_core
          flutter pub get
          
          # 2. 再配置主程序
          cd ../simple_live_app
          flutter pub get
          
          # 3. 运行代码生成器 (重要：该项目使用 Hive 需要这一步)
          flutter pub run build_runner build --delete-conflicting-outputs
        shell: bash

      - name: Build App
        run: |
          cd simple_live_app
          if [ "${{ matrix.platform }}" = "android" ]; then
            # 加上 --no-tree-shake-icons 防止某些图标库导致的编译错误
            flutter build apk --release --no-tree-shake-icons
          elif [ "${{ matrix.platform }}" = "windows" ]; then
            flutter build windows --release
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            flutter build macos --release
          fi
        shell: bash

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-release
          path: |
            simple_live_app/build/app/outputs/flutter-apk/app-release.apk
            simple_live_app/build/windows/runner/Release/
            simple_live_app/build/macos/Build/Products/Release/
